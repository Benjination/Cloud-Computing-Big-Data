<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Search & Analysis - Quiz Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .search-section {
            margin-bottom: 30px;
        }
        .analysis-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .results-table {
            max-height: 600px;
            overflow-y: auto;
        }
        .pagination-container {
            margin: 20px 0;
            text-align: center;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        .search-card {
            transition: transform 0.2s;
        }
        .search-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Navigation</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="window.location.href='/'">
                            Back to Upload
                        </button>
                        <button class="btn btn-outline-secondary w-100" onclick="refreshData()">
                            Refresh Data
                        </button>
                    </div>
                </div>

                <!-- Database Stats -->
                <div class="card stats-card mb-4">
                    <div class="card-body">
                        <h5>Database Statistics</h5>
                        <div id="statsContent">
                            <div class="text-center">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h6>Quick Analysis</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-info btn-sm w-100 mb-2" onclick="runAnalysis('summary')">
                            Data Summary
                        </button>
                        <button class="btn btn-info btn-sm w-100 mb-2" onclick="runAnalysis('pattern1')">
                            Pattern Analysis 1
                        </button>
                        <button class="btn btn-info btn-sm w-100 mb-2" onclick="runAnalysis('pattern2')">
                            Pattern Analysis 2
                        </button>
                        <button class="btn btn-info btn-sm w-100" onclick="runAnalysis('pattern3')">
                            Pattern Analysis 3
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                <h1 class="mb-4">Data Search & Analysis Interface</h1>

                <!-- Search Functions -->
                <div class="row">
                    <!-- Numeric Search -->
                    <div class="col-md-6 mb-4">
                        <div class="card search-card h-100">
                            <div class="card-header">
                                <h6>Numeric Value Search</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="numericThreshold" class="form-label">Threshold Value</label>
                                    <input type="number" class="form-control" id="numericThreshold" 
                                           placeholder="Enter threshold" step="0.1">
                                </div>
                                <div class="mb-3">
                                    <label for="numericOperator" class="form-label">Operator</label>
                                    <select class="form-select" id="numericOperator">
                                        <option value="greater">Greater than</option>
                                        <option value="less">Less than</option>
                                        <option value="equal">Equal to</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary w-100" onclick="searchNumeric()">
                                    Search by Value
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Text Search -->
                    <div class="col-md-6 mb-4">
                        <div class="card search-card h-100">
                            <div class="card-header">
                                <h6>Text Search</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="textSearch" class="form-label">Search Term</label>
                                    <input type="text" class="form-control" id="textSearch" 
                                           placeholder="Enter search term">
                                </div>
                                <div class="mb-4"></div> <!-- Spacer for alignment -->
                                <button class="btn btn-success w-100" onclick="searchText()">
                                    Search Text
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Location Search -->
                    <div class="col-md-6 mb-4">
                        <div class="card search-card h-100">
                            <div class="card-header">
                                <h6>Location Search</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="searchLat" class="form-label">Latitude</label>
                                        <input type="number" class="form-control" id="searchLat" 
                                               placeholder="Latitude" step="0.000001">
                                    </div>
                                    <div class="col-6">
                                        <label for="searchLng" class="form-label">Longitude</label>
                                        <input type="number" class="form-control" id="searchLng" 
                                               placeholder="Longitude" step="0.000001">
                                    </div>
                                </div>
                                <div class="mb-3 mt-2">
                                    <label for="radius" class="form-label">Radius (km)</label>
                                    <input type="number" class="form-control" id="radius" 
                                           placeholder="Radius" value="10" step="1">
                                </div>
                                <button class="btn btn-warning w-100" onclick="searchLocation()">
                                    Search by Location
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Category Search -->
                    <div class="col-md-6 mb-4">
                        <div class="card search-card h-100">
                            <div class="card-header">
                                <h6>Category Search</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="categorySelect" class="form-label">Category</label>
                                    <select class="form-select" id="categorySelect">
                                        <option value="">Loading categories...</option>
                                    </select>
                                </div>
                                <div class="mb-4"></div> <!-- Spacer for alignment -->
                                <button class="btn btn-info w-100" onclick="searchCategory()">
                                    Search Category
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="card mb-4" id="analysisCard" style="display: none;">
                    <div class="card-header">
                        <h5>Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="analysisResults"></div>
                    </div>
                </div>

                <!-- Search Results -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Search Results</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportResults()">
                                Export CSV
                            </button>
                            <button class="btn btn-outline-danger btn-sm ms-2" onclick="clearResults()">
                                Clear Results
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="loadingIndicator" class="loading" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Searching...</span>
                            </div>
                            <p class="mt-2">Searching database...</p>
                        </div>
                        
                        <div id="resultsInfo" class="mb-3"></div>
                        
                        <div class="results-table">
                            <div id="resultsTable"></div>
                        </div>
                        
                        <div id="pagination" class="pagination-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let currentResults = [];
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalPages = 0;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadCategories();
        });

        // Load database statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('statsContent').innerHTML = `
                        <div class="row text-center">
                            <div class="col-12">
                                <h3>${data.total_records}</h3>
                                <p class="mb-0">Total Records</p>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('statsContent').innerHTML = `
                    <p class="text-center">Error loading stats</p>
                `;
                console.error('Stats loading error:', error);
            }
        }

        // Load categories for dropdown
        async function loadCategories() {
            try {
                const response = await fetch('/api/analysis/summary');
                const data = await response.json();
                
                if (response.ok && data.category_distribution) {
                    const select = document.getElementById('categorySelect');
                    select.innerHTML = '<option value="">Select a category</option>';
                    
                    data.category_distribution.forEach(item => {
                        if (item.category) {
                            const option = document.createElement('option');
                            option.value = item.category;
                            option.textContent = `${item.category} (${item.count})`;
                            select.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Search Functions
        async function searchNumeric() {
            const threshold = parseFloat(document.getElementById('numericThreshold').value);
            const operator = document.getElementById('numericOperator').value;
            
            if (isNaN(threshold)) {
                alert('Please enter a valid number');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/search/numeric', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        threshold: threshold,
                        operator: operator
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data.results, `Numeric search: ${operator} ${threshold}`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Search failed: ' + error.message);
                console.error('Search error:', error);
            } finally {
                showLoading(false);
            }
        }

        async function searchText() {
            const searchTerm = document.getElementById('textSearch').value.trim();
            
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/search/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        search_term: searchTerm
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data.results, `Text search: "${searchTerm}"`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Search failed: ' + error.message);
                console.error('Search error:', error);
            } finally {
                showLoading(false);
            }
        }

        async function searchLocation() {
            const lat = parseFloat(document.getElementById('searchLat').value);
            const lng = parseFloat(document.getElementById('searchLng').value);
            const radius = parseFloat(document.getElementById('radius').value);
            
            if (isNaN(lat) || isNaN(lng) || isNaN(radius)) {
                alert('Please enter valid coordinates and radius');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/search/location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng,
                        radius: radius
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data.results, `Location search: ${radius}km from (${lat}, ${lng})`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Search failed: ' + error.message);
                console.error('Search error:', error);
            } finally {
                showLoading(false);
            }
        }

        async function searchCategory() {
            const category = document.getElementById('categorySelect').value;
            
            if (!category) {
                alert('Please select a category');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/search/category', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category: category
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    displayResults(data.results, `Category: "${category}"`);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Search failed: ' + error.message);
                console.error('Search error:', error);
            } finally {
                showLoading(false);
            }
        }

        // Analysis Functions
        async function runAnalysis(type) {
            showLoading(true);
            
            try {
                const response = await fetch(`/api/analysis/${type}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayAnalysis(data, type);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                alert('Analysis failed: ' + error.message);
                console.error('Analysis error:', error);
            } finally {
                showLoading(false);
            }
        }

        function displayAnalysis(data, type) {
            const analysisCard = document.getElementById('analysisCard');
            const analysisResults = document.getElementById('analysisResults');
            
            let html = `<h6>${data.analysis_type || 'Analysis Results'}</h6>`;
            
            if (type === 'summary') {
                html += `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Numeric Field Statistics</h6>
                            <ul class="list-unstyled">
                                <li><strong>Average:</strong> ${data.numeric_field_stats.average.toFixed(2)}</li>
                                <li><strong>Minimum:</strong> ${data.numeric_field_stats.minimum}</li>
                                <li><strong>Maximum:</strong> ${data.numeric_field_stats.maximum}</li>
                                <li><strong>Count:</strong> ${data.numeric_field_stats.count}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Category Distribution</h6>
                            <ul class="list-unstyled">
                `;
                
                data.category_distribution.forEach(item => {
                    html += `<li><strong>${item.category}:</strong> ${item.count}</li>`;
                });
                
                html += '</ul></div></div>';
            } else {
                // For pattern analyses
                if (data.data && Array.isArray(data.data)) {
                    html += '<div class="table-responsive"><table class="table table-sm">';
                    html += '<thead><tr>';
                    
                    // Get headers from first data item
                    if (data.data.length > 0) {
                        Object.keys(data.data[0]).forEach(key => {
                            html += `<th>${key}</th>`;
                        });
                    }
                    
                    html += '</tr></thead><tbody>';
                    
                    data.data.forEach(item => {
                        html += '<tr>';
                        Object.values(item).forEach(value => {
                            html += `<td>${value}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                }
            }
            
            analysisResults.innerHTML = html;
            analysisCard.style.display = 'block';
        }

        // Results Display Functions
        function displayResults(results, searchDescription) {
            currentResults = results;
            currentPage = 1;
            totalPages = Math.ceil(results.length / itemsPerPage);
            
            document.getElementById('resultsInfo').innerHTML = `
                <div class="alert alert-info">
                    <strong>Search:</strong> ${searchDescription}<br>
                    <strong>Results:</strong> ${results.length} records found
                    ${totalPages > 1 ? ` (Page ${currentPage} of ${totalPages})` : ''}
                </div>
            `;
            
            displayCurrentPage();
            setupPagination();
        }

        function displayCurrentPage() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageResults = currentResults.slice(start, end);
            
            if (pageResults.length === 0) {
                document.getElementById('resultsTable').innerHTML = 
                    '<div class="alert alert-warning">No results found.</div>';
                return;
            }

            // CUSTOMIZE THIS TABLE STRUCTURE FOR YOUR DATA
            let html = '<table class="table table-striped table-hover">';
            html += '<thead class="table-dark"><tr>';
            html += '<th>ID</th>';
            html += '<th>Field 1</th>';  // CHANGE TO YOUR FIELD NAMES
            html += '<th>Field 2</th>';  // CHANGE TO YOUR FIELD NAMES
            html += '<th>Numeric Value</th>';  // CHANGE TO YOUR FIELD NAMES
            html += '<th>Category</th>';  // CHANGE TO YOUR FIELD NAMES
            html += '<th>Date</th>';  // CHANGE TO YOUR FIELD NAMES
            html += '</tr></thead><tbody>';
            
            pageResults.forEach(result => {
                html += '<tr>';
                html += `<td>${result.id}</td>`;
                html += `<td>${result.field1 || ''}</td>`;  // CHANGE TO YOUR FIELDS
                html += `<td>${result.field2 || ''}</td>`;  // CHANGE TO YOUR FIELDS
                html += `<td>${result.numeric_field || ''}</td>`;  // CHANGE TO YOUR FIELDS
                html += `<td>${result.category || ''}</td>`;  // CHANGE TO YOUR FIELDS
                html += `<td>${result.date_field ? new Date(result.date_field).toLocaleDateString() : ''}</td>`;  // CHANGE TO YOUR FIELDS
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('resultsTable').innerHTML = html;
        }

        function setupPagination() {
            if (totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            let html = '<nav><ul class="pagination justify-content-center">';
            
            // Previous button
            if (currentPage > 1) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
                </li>`;
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<li class="page-item ${activeClass}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            }
            
            // Next button
            if (currentPage < totalPages) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
                </li>`;
            }
            
            html += '</ul></nav>';
            document.getElementById('pagination').innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            displayCurrentPage();
            setupPagination();
            
            // Update results info
            document.getElementById('resultsInfo').innerHTML = `
                <div class="alert alert-info">
                    <strong>Results:</strong> ${currentResults.length} records found
                    (Page ${currentPage} of ${totalPages})
                </div>
            `;
        }

        // Utility Functions
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function clearResults() {
            currentResults = [];
            document.getElementById('resultsTable').innerHTML = '';
            document.getElementById('resultsInfo').innerHTML = '';
            document.getElementById('pagination').innerHTML = '';
            document.getElementById('analysisCard').style.display = 'none';
        }

        function refreshData() {
            loadStats();
            loadCategories();
            clearResults();
        }

        function exportResults() {
            if (currentResults.length === 0) {
                alert('No results to export');
                return;
            }

            // Convert results to CSV
            const headers = Object.keys(currentResults[0]);
            const csvContent = [
                headers.join(','),
                ...currentResults.map(row => 
                    headers.map(header => 
                        JSON.stringify(row[header] || '')
                    ).join(',')
                )
            ].join('\n');

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'search_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>