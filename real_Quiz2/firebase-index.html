<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Upload - Quiz Project</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .container { background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0; }
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .progress { background: #f0f0f0; border-radius: 4px; margin: 10px 0; }
        .progress-bar { background: #4CAF50; height: 20px; border-radius: 4px; transition: width 0.3s; }
        input[type="file"] { margin: 10px 0; padding: 10px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .config-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 20px 0; }
        
        /* Student Header Styles */
        .student-header {
            background: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 3px solid #4CAF50;
        }
        
        .student-name {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .student-id {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <!-- Student Header -->
    <div class="student-header">
        <img src="Face.png" alt="Benjamin Niccum" class="student-photo">
        <div class="student-name">Benjamin Niccum</div>
        <div class="student-id">Last 2 Digits: 09</div>
    </div>

    <h1>Data Analysis Project - Firebase Upload</h1>
    
    <div class="container">
        <h2>CSV/TSV Data Upload</h2>
        <p>Upload your data file (supports both comma-separated and tab-separated formats)</p>
        
        <input type="file" id="csvFile" accept=".csv,.tsv,.txt" />
        <button onclick="uploadCSV()">Upload Data to Firebase</button>
        
        <div class="progress" style="display: none;" id="progressContainer">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        
        <div id="uploadStatus"></div>
    </div>

    <div class="container">
        <h2>Database Management</h2>
        <p>‚ö†Ô∏è <strong>Warning:</strong> This will permanently delete ALL data from the database!</p>
        <button onclick="clearDatabase()" style="background: #dc3545;">Clear All Data</button>
        <div id="clearStatus"></div>
    </div>

        <div class="container">
        <h2>Navigation</h2>
        <button onclick="window.location.href='search-landing.html'">Go to Search & Analysis</button>
        <button onclick="window.location.href='index.html'">Back to Main Page</button>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // üî• FIREBASE CONFIGURATION FOR PROJECT: realquiz2-a1d06
        const firebaseConfig = {
            apiKey: "AIzaSyARxVQ5jA7HZoYKZUSyxDsuHh9-b6pidWQ",
            authDomain: "realquiz2-a1d06.firebaseapp.com",
            projectId: "realquiz2-a1d06",
            storageBucket: "realquiz2-a1d06.firebasestorage.app",
            messagingSenderId: "1020294472984",
            appId: "1:1020294472984:web:3aee76d6a34be40d47ea6d",
            measurementId: "G-6NBBPMXKXL"
        };

        // Config is now properly set
        console.log("‚úÖ Firebase configuration loaded for project:", firebaseConfig.projectId);

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
        import { getFirestore, collection, addDoc, writeBatch, doc, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make database available globally
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.writeBatch = writeBatch;
        window.doc = doc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;

        // Collection name - CHANGE THIS FOR YOUR QUIZ DATA
        window.COLLECTION_NAME = "quiz_data";

        // CSV Upload Function - CUSTOMIZE FOR YOUR DATA
        window.uploadCSV = async function() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            // Check if file is selected
            if (!file) {
                statusDiv.innerHTML = '<div class="status error">Please select a CSV file</div>';
                return;
            }

            try {
                statusDiv.innerHTML = '<div class="status">Reading file...</div>';
                const csvText = await file.text();
                const lines = csvText.split('\n');
                
                // Auto-detect delimiter (comma or tab)
                const firstLine = lines[0];
                let delimiter = ',';
                if (firstLine.includes('\t') && firstLine.split('\t').length > firstLine.split(',').length) {
                    delimiter = '\t';
                }
                
                const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
                
                console.log('CSV Headers detected:', headers);
                console.log('Delimiter detected:', delimiter === '\t' ? 'TAB' : 'COMMA');
                statusDiv.innerHTML = `<div class="status">Found ${lines.length - 1} records with columns: ${headers.join(', ')}<br>Delimiter: ${delimiter === '\t' ? 'TAB-separated' : 'COMMA-separated'}<br>Starting upload...</div>`;
                
                progressContainer.style.display = 'block';
                const batchSize = 500;
                let batch = writeBatch(db);
                let batchCount = 0;
                let totalProcessed = 0;
                
                // CUSTOMIZE THIS SECTION BASED ON YOUR DATA FIELDS
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                        const record = {};
                        
                        headers.forEach((header, index) => {
                            if (values[index]) {
                                let value = values[index];
                                
                                // Handle -1 as null for missing numeric data
                                if (value === '-1' || value === -1) {
                                    value = null;
                                }
                                // Handle empty strings as null
                                else if (value === '' || value === 'null' || value === 'NULL') {
                                    value = null;
                                }
                                // AUTO-DETECT AND CONVERT DATA TYPES
                                // Numeric fields (common patterns)
                                else if (header.toLowerCase().includes('price') || 
                                    header.toLowerCase().includes('rating') || 
                                    header.toLowerCase().includes('amount') || 
                                    header.toLowerCase().includes('value') ||
                                    header.toLowerCase().includes('score') ||
                                    header.toLowerCase().includes('quantity') ||
                                    header.toLowerCase().includes('lat') || 
                                    header.toLowerCase().includes('lng') ||
                                    header.toLowerCase().includes('longitude') || 
                                    header.toLowerCase().includes('latitude') ||
                                    header.toLowerCase().includes('magnitude') ||
                                    header.toLowerCase().includes('depth') ||
                                    header.toLowerCase().includes('nst') ||
                                    (!isNaN(parseFloat(value)) && isFinite(value) && value.includes('.'))) {
                                    value = parseFloat(value) || null;
                                }
                                // Integer fields
                                else if (header.toLowerCase().includes('count') ||
                                         header.toLowerCase().includes('id') ||
                                         (!isNaN(parseInt(value)) && !value.includes('.') && value.match(/^\d+$/))) {
                                    value = parseInt(value) || null;
                                }
                                // Date fields (common patterns)
                                else if (header.toLowerCase().includes('date') || 
                                         header.toLowerCase().includes('time') || 
                                         header.toLowerCase().includes('created') || 
                                         header.toLowerCase().includes('updated') ||
                                         value.match(/\d{4}-\d{2}-\d{2}/) ||
                                         value.match(/\d{1,2}\/\d{1,2}\/\d{4}/)) {
                                    try {
                                        value = new Date(value);
                                        if (isNaN(value.getTime())) value = null;
                                    } catch {
                                        value = null;
                                    }
                                }
                                
                                record[header] = value;
                            }
                        });
                        
                        const docRef = doc(collection(db, window.COLLECTION_NAME));
                        batch.set(docRef, record);
                        batchCount++;
                        totalProcessed++;
                        
                        if (batchCount >= batchSize) {
                            await batch.commit();
                            batch = writeBatch(db);
                            batchCount = 0;
                            
                            const progress = (totalProcessed / (lines.length - 1)) * 100;
                            progressBar.style.width = progress + '%';
                            statusDiv.innerHTML = `<div class="status">Uploaded ${totalProcessed} records...</div>`;
                        }
                    }
                }
                
                if (batchCount > 0) {
                    await batch.commit();
                }
                
                progressBar.style.width = '100%';
                statusDiv.innerHTML = `<div class="status success">‚úÖ Upload complete! ${totalProcessed} records uploaded successfully to collection: ${window.COLLECTION_NAME}</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Upload failed: ${error.message}</div>`;
                console.error('Upload error:', error);
            }
        };

        // Clear Database Function - REMOVES ALL DATA
        window.clearDatabase = async function() {
            const statusDiv = document.getElementById('clearStatus');
            
            // Confirm deletion
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL data from the database? This cannot be undone!')) {
                return;
            }
            
            try {
                statusDiv.innerHTML = `<div class="status">üîÑ Clearing database...</div>`;
                
                // Get all documents from the collection
                const querySnapshot = await getDocs(collection(db, window.COLLECTION_NAME));
                
                if (querySnapshot.empty) {
                    statusDiv.innerHTML = `<div class="status success">‚úÖ Database is already empty.</div>`;
                    return;
                }
                
                // Delete documents in batches
                const batch = writeBatch(db);
                let deleteCount = 0;
                
                querySnapshot.forEach((document) => {
                    batch.delete(doc(db, window.COLLECTION_NAME, document.id));
                    deleteCount++;
                });
                
                await batch.commit();
                
                statusDiv.innerHTML = `<div class="status success">‚úÖ Database cleared! Deleted ${deleteCount} records from collection: ${window.COLLECTION_NAME}</div>`;
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Clear failed: ${error.message}</div>`;
                console.error('Clear error:', error);
            }
        };


    </script>
</body>
</html>